name: sf_deployment

on:
  push:
    branches:
      - 'release/**'

jobs:
  ddl_deploy:
    runs-on: ubuntu-18.04

    steps:
      - name: Copy files
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
        
      - name: Check copied files
        run: ls -la
      
  #    - name: Install SnowSQL
   #     run: |
    #      curl -O https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.2/linux_x86_64/snowsql-1.2.21-linux_x86_64.bash
     #     SNOWSQL_DEST=~/bin SNOWSQL_LOGIN_SHELL=~/.profile bash snowsql-1.2.21-linux_x86_64.bash
      #    ls -la
      
      - name: Install Alien
        run: sudo apt-get install alien
        
      - name: Install rpm file
        run: curl -O https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.2/linux_x86_64/snowflake-snowsql-1.2.21-1.x86_64.rpm
      
      - name: Convert rpm to deb    
        run: sudo alien --to-deb snowflake-snowsql-1.2.21-1.x86_64.rpm
     
      - name: Check files
        run: ls -la
     
      - name: Install SnowSQL
        run: sudo dpkg -i snowflake-snowsql_1.2.21-2_amd64.deb
      
      - name: Check files and SnowSQL version
        run: |
          pwd
          ls -la
          snowsql -v
      - name: RUN SNOWSQL
        run: |
          list_of_files=
          touch changed_and_new_files.txt
          latest_release_branch=$(git branch | grep release | tail -1)
          latest_release_branch=${latest_release_branch##*'* '}
          echo "==================="
          echo ${latest_release_branch}
          
          previouse_release_branch=$(git branch | grep release | tail -2 | head -n 1)
          echo "==================="
          previouse_release_branch=${previouse_release_branch##*'* '}
          echo ${previouse_release_branch}
          echo " CHECK 1 *********.    $latest_release_branch CHECK 2*************** $previouse_release_branch"
          if [$latest_release_branch -eq $previouse_release_branch]
          then
            echo "CHECK 3.1.1 ********* NOT FIRST RELEASE"
            search_dir=/home/runner/work/git_actions_test/git_actions_test/DDLs
            for entry in "$search_dir"/*
            do
              list_of_files="$list_of_files -f $entry"
            done
            echo "CHECK 3.1.2 *********"
          else
            echo "CHECK 3.2.1 ********* FIRST RELEASE"
            echo "git diff --name-only $latest_release_branch..$previouse_release_branch"
            git diff --name-only $latest_release_branch..$previouse_release_branch >> changed_and_new_files.txt 
            file="changed_and_new_files.txt"
            changed_and_new_files=$(cat $file)
            for line in $changed_and_new_files
            do
              if [[ $line == *".ddl"* ]]; 
              then
                list_of_files="$list_of_files -f ${line##*/}"
              fi
            done
            echo "CHECK 3.2.2 *********"
          fi 
          
          echo "echo "CHECK 4 ********* $list_of_files"
          
          export SNOWSQL_PWD=7434673Sn 
          snowsql $list_of_files -a vw86460.east-us-2.azure -u alijkee -d STRIIM -s PUBLIC -r ACCOUNTADMIN -w COMPUTE_WH -D password=$SNOWSQL_PWD

          
          
          
          
          
          
          
        
